name: 'Setup PostgreSQL Preview Schema'
description: 'Sets up a PostgreSQL preview schema by cloning the main schema'
inputs:
  deployment-name:
    description: 'Name of the deployment (used for ConfigMap name)'
    required: true
  namespace:
    description: 'Kubernetes namespace'
    required: true
  preview-number:
    description: 'Preview number (PR number)'
    required: true
  secret-name:
    description: 'Name of the secret containing DB password'
    required: false
    default: 'app-secrets'

runs:
  using: "composite"
  steps:
    - name: Prepare setup-schema job
      run: |
        JOB_NAME="prepare-schema-preview-${{ inputs.preview-number }}"
        CONFIGMAP_NAME="${{ inputs.deployment-name }}-environments"
        
        # Create a temporary file for the manifest
        cp ${{ github.action_path }}/job-template.yml job-setup-schema.yml
        
        # Replace placeholders
        sed -i "s/JOB_NAME_PLACEHOLDER/$JOB_NAME/g" job-setup-schema.yml
        sed -i "s/CONFIGMAP_NAME_PLACEHOLDER/$CONFIGMAP_NAME/g" job-setup-schema.yml
        sed -i "s/SECRET_NAME_PLACEHOLDER/${{ inputs.secret-name }}/g" job-setup-schema.yml
        sed -i "s/PREVIEW_NUMBER_PLACEHOLDER/${{ inputs.preview-number }}/g" job-setup-schema.yml
        
        echo "Prepared job manifest: job-setup-schema.yml"
      shell: bash

    - name: Create setup-schema job
      run: |
        kubectl apply --namespace ${{ inputs.namespace }} -f job-setup-schema.yml
      shell: bash

    - name: Wait for setup-schema job to complete
      run: |
        JOB_NAME="prepare-schema-preview-${{ inputs.preview-number }}"
        NAMESPACE="${{ inputs.namespace }}"
        
        echo "Waiting for job $JOB_NAME in namespace $NAMESPACE..."
        
        if kubectl wait --namespace $NAMESPACE --for=condition=complete --timeout=60s job/$JOB_NAME; then
          echo "Job finished with status: Complete"
          kubectl logs job/$JOB_NAME --namespace $NAMESPACE
        elif kubectl wait --namespace $NAMESPACE --for=condition=failed --timeout=1s job/$JOB_NAME; then
          echo "Job finished with status: Failed"
          kubectl logs job/$JOB_NAME --namespace $NAMESPACE
          exit 1
        else
          echo "Timeout waiting for job to complete."
          kubectl logs job/$JOB_NAME --namespace $NAMESPACE || true
          exit 1
        fi
      shell: bash
